<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.member.dao.MemberRecommendDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.gt.member.entity.MemberRecommend">
		<id column="id" property="id" />
		<result column="busId" property="busId"/>
		<result column="memberId" property="memberId" />
		<result column="name" property="name" />
		<result column="phone" property="phone" />
		<result column="ischeck" property="ischeck" />
		<result column="code" property="code" />
		<result column="ctId" property="ctId" />
		<result column="image" property="image" />
		<result column="isUser" property="isUser" />
		<result column="integral" property="integral" />
		<result column="fenbi" property="fenbi" />
		<result column="flow" property="flow" />
		<result column="datetime" property="datetime" />
		<result column="retext" property="retext" />
		<result column="money" property="money" />
		<result column="reType" property="reType" />
		<result column="cardId" property="cardId" />
		<result column="recommendType" property="recommendType" />
		<result column="lingquNum" property="lingquNum" />
		<result column="userNum" property="userNum" />
		<result column="cardName" property="cardName" />
		<result column="getMemberId" property="getMemberId" />
		<result column="isGive" property="isGive" />
	</resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, busId,memberId, name, phone, ischeck, code, ctId, image, isUser, integral, fenbi, flow, datetime, retext, money, reType,
         cardId, recommendType, lingquNum, userNum, cardName,getMemberId,isGive
    </sql>


	<select id="findByMemberId" resultType="Map">
		select  name,integral,fenbi,flow,recommendType,cardName,lingquNum,userNum,isGive,money,datetime from t_member_recommend
		where recommendType=0 and
			<foreach collection="memberIds" item="memberId"  separator="or">
				 memberId=#{memberId}
			</foreach>
		order by id desc
	</select>

	<select id="findBycode" resultMap="BaseResultMap">
		select * from t_member_recommend where ischeck=1 and isUser=0  and code=#{code} and ctId=#{ctId}
		limit 1
	</select>

	<select id="countTuiJian" resultType="java.lang.Integer">
		select count(t.id) from t_member_recommend t inner join
		t_wx_bus_member m on
		m.id=t.memberId
		where m.busId=#{busId}
		<if test="ctId>0">
			and t.ctId=#{ctId}
		</if>
		 and
		t.isUser=1
	</select>

	<select id="selectIsNotUserCode" parameterType="com.gt.member.entity.MemberRecommend" resultType="Map">
		select * from t_member_recommend where memberId=#{memberid} and isUser=0 and reType=#{retype}
		order by id desc
	</select>


	<select id="findRecommendByCode" resultMap="BaseResultMap">
		select * from t_member_recommend where ischeck=1 and isUser=0 and code=#{code}
	</select>


	<select id="countRecommendByCardId" resultType="java.lang.Integer">
		select count(id) from t_member_recommend where cardId=#{cardId} and memberId=#{memberId}
	</select>

	<select id="findRecommendByCardId" resultMap="BaseResultMap">
		select <include refid="Base_Column_List" /> from t_member_recommend
		where cardId=#{cardId} and memberId=#{memberId} and recommendType=1
	</select>

	<select id="findRecommendByphone" resultType="java.lang.Integer">
		select count(id) from t_member_recommend where memberId=#{memberId} and phone=#{phone}
	</select>

	<select id="countRecommendSuccessByMemberId" resultType="Map">
		SELECT SUM(integral) as totalIntegral,SUM(fenbi) as totalFenbi,SUM(flow) as totalFlow,SUM(money) as totalMoney,
		 COUNT(*) as successNum FROM t_member_recommend WHERE memberId=#{memberId} and recommendType=1 and isGive=1
	</select>

	<select id="countRecommendByMemberId" resultType="java.lang.Integer">
		select count(*) as number  FROM t_member_recommend WHERE memberId=#{memberId} and recommendType=1
	</select>

	<select id="findRecommendPageByMemberId" resultType="Map">
		select r.isUser,r.integral,r.fenbi,r.flow,r.datetime,r.money,m.nickname from t_member_recommend r
		inner join t_wx_bus_member m on m.id=r.getMemberId
		where r.memberId=#{memberId} and r.recommendType=1
		ORDER BY r.id DESC
		limit #{firstResult},#{pageSize}
	</select>

    <select id="selectRecommendListCount" resultType="java.lang.Integer" parameterType="hashmap">
          select count(1) from t_member_recommend r INNER JOIN t_wx_bus_member m ON r.memberId =m.id
		<where>
			<if test="busId!=null and busId!=''">
				AND  r.busId=${busId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND (m.phone like '%${searchContent}%' or r.cardName like '%${searchContent}%' )
			</if>
		</where>
	</select>

	<select id="selectRecommendList" resultType="java.util.Map" parameterType="hashmap">
		select m.nickname,m.phone  as userPhone,r.* from t_member_recommend r INNER JOIN t_wx_bus_member m ON r.memberId =m.id
		<where>
			<if test="busId!=null and busId!=''">
				AND  r.busId=${busId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND (m.phone like '%${searchContent}%' or r.cardName like '%${searchContent}%' )
			</if>
		</where>
	</select>
	<select id="selectRecommendReceiveListCount" resultType="java.lang.Integer" parameterType="hashmap">
		select count(1)  from t_duofen_card_get_new g INNER JOIN t_wx_bus_member m ON g.memberId =m.id
		<where>
			<if test="recommendId!=null and recommendId!=''">
				AND  g.recommendId=${recommendId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND ( m.phone  like '%${searchContent}%'   or g.code  like '%${searchContent}%')
			</if>
		</where>
	</select>
	<select id="selectRecommendReceiveList" resultType="java.util.Map"  parameterType="hashmap">
		   select m.nickname,m.phone,g.*  from t_duofen_card_get_new g INNER JOIN t_wx_bus_member m ON g.memberId =m.id
		<where>
			<if test="recommendId!=null and recommendId!=''">
				AND  g.recommendId=${recommendId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND ( m.phone  like '%${searchContent}%'   or g.code  like '%${searchContent}%')
			</if>
		</where>
	</select>
	<select id="selectWithdrawListCount" resultType="java.lang.Integer" parameterType="hashmap">
		select count(1) from  t_member_picklog  p INNER JOIN  t_wx_bus_member m ON p.memberId=m.id
		<where>
			<if test="busId!=null and busId!=''">
				AND  p.busId=${busId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND m.phone like '%${searchContent}%'
			</if>
		</where>
	</select>

	<select id="selectWithdrawList" resultType="java.util.Map" parameterType="hashmap">
			select m.phone,m.nickname,p.* from  t_member_picklog  p INNER JOIN  t_wx_bus_member m ON p.memberId=m.id
		<where>
			<if test="busId!=null and busId!=''">
				AND  p.busId=${busId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND m.phone like '%${searchContent}%'
			</if>
		</where>
	</select>

	<!--<select id="selectReceiveCouponCount"  parameterType="hashmap" resultType="java.lang.Integer">
		select count(1) from t_duofen_card_get_new c INNER JOIN t_wx_bus_member m on c.memberId=m.id
		<where>
			<if test="cardId!=null and cardId!=''">
				AND  c.cardId=${cardId}
			</if>
			<if test="searchContent!=null and searchContent!=''">
				AND m.phone like '%${searchContent}%'
			</if>
		</where>
	</select>
-->

	<select id="findRecommendByBusIdAndCode" resultType="Map">
		select * from t_member_recommend where busId=#{busId}  and recommendType=1 and code=#{code}

	</select>

</mapper>
