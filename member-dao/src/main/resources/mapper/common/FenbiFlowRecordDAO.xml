<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.member.dao.common.FenbiFlowRecordDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.gt.common.entity.FenbiFlowRecord">
		<id column="id" property="id" />
		<result column="bus_user_id" property="busUserId" />
		<result column="rec_type" property="recType" />
		<result column="rec_count" property="recCount" />
		<result column="rec_use_count" property="recUseCount" />
		<result column="rec_createTime" property="recCreateTime" />
		<result column="rec_desc" property="recDesc" />
		<result column="rec_freeze_type" property="recFreezeType" />
		<result column="rec_fk_id" property="recFkId" />
		<result column="roll_status" property="rollStatus" />
		<result column="flow_type" property="flowType" />
		<result column="flow_id" property="flowId" />
	</resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, bus_user_id, rec_type, rec_count, rec_use_count, rec_createTime, rec_desc, rec_freeze_type, rec_fk_id, roll_status, flow_type, flow_id
    </sql>

	<select id="getFenbiSurplus" resultType="java.lang.Double">
		SELECT IFNULL(SUM(rec_count-rec_use_count),0) AS num
		FROM t_wx_fenbi_flow_record
		WHERE bus_user_id =#{userId}
		AND rec_type= #{rec_type}
		AND rec_freeze_type = #{fre_type}
		AND rec_fk_id = #{fkId}
		AND roll_status=1
	</select>


	<update id="updateFenbiReduce">
		UPDATE t_wx_fenbi_flow_record t SET t.rec_use_count = t.rec_use_count + #{num}
		WHERE t.bus_user_id = #{userId} AND t.rec_fk_id = #{fkId} AND t.rec_freeze_type = #{fre_type} and t.rec_type = 1
	</update>

</mapper>
