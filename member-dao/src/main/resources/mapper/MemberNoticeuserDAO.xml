<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.member.dao.MemberNoticeuserDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.gt.member.entity.MemberNoticeuser">
		<id column="id" property="id" />
		<result column="busId" property="busId" />
		<result column="noticeId" property="noticeId" />
		<result column="msgType" property="msgType" />
		<result column="status" property="status" />
		<result column="sendDate" property="sendDate" />
		<result column="createDate" property="createDate" />
		<result column="msgId" property="msgId" />
		<result column="phone" property="phone" />
	</resultMap>

	<!-- 通用查询结果列 -->
	<sql id="Base_Column_List">
        busId AS busId, noticeId AS noticeId, msgType AS msgType, status, sendDate AS sendDate, createDate AS createDate, id, msgId AS msgId, phone
    </sql>


	<select id="findByNoticeId" resultType="Map">
		select * from t_member_noticeuser where noticeid=#{noticeId} and msgType=0
	</select>

	<select id="findCountNotice" resultType="java.lang.Integer">
		select count(noticeId) from t_member_noticeuser where busId=#{memberId}   and msgType=1 and status=0 and sendDate <![CDATA[ <= ]]> #{sendDate}
	</select>

	<select id="findNotice" resultType="Map">
		SELECT n.* FROM t_member_noticeuser nu
		INNER JOIN t_member_notice n ON nu.noticeId=n.id
		WHERE nu.busId=#{memberId} AND nu.msgType=1
		AND noticeId IN
		(SELECT id FROM t_member_notice nd WHERE (nd.sendType=1 AND nd.sendDate <![CDATA[ <= ]]> #{sendDate}) OR (nd.sendType=0))
		ORDER BY nu.createDate DESC

	</select>

	<update id="updateStatus">
		update t_member_noticeuser set status=1  where busId=#{memberId} and msgType=1
	</update>


	<select id="findNotice1" resultType="Map">
		SELECT * FROM t_member_noticeuser nu
		INNER JOIN t_member_notice n ON nu.noticeId=n.id
		WHERE nu.busId=#{memberId} and nu.noticeId=#{noticeId}
	</select>

	<delete id="deleteByNoticeId">
		delete from t_member_noticeuser  where noticeId=#{noticeId}
	</delete>


	<insert id="saveList">
		insert into t_member_noticeuser (busId, noticeId, msgType,
		status, sendDate,phone)
		values
		<foreach collection="noticeUsers" index="index" item="n" separator=",">
			(#{n.busId,jdbcType=INTEGER}, #{n.noticeId,jdbcType=INTEGER}, #{n.msgType,jdbcType=TINYINT},
			#{n.status,jdbcType=TINYINT}, #{n.sendDate,jdbcType=TIMESTAMP},#{n.phone,jdbcType=VARCHAR})
		</foreach>
	</insert>


	<select id="findByNoticeIdAndMemberId" resultMap="BaseResultMap">
		select * from t_member_noticeuser where noticeId=#{noticeId} and busId=#{memberId}

	</select>

	<select id="updateByIds">
		update t_member_noticeuser set status=3 ,msgId=#{msgId}
		<where>
			<foreach collection="ids" item="id"  open="(" separator="or" close=")">
				id=#{id}
			</foreach>

		</where>

	</select>


	<update id="updateByMsgIdAndPhone">
		update t_member_noticeuser set status=#{status} where msgId=#{msgId} and phone=#{phone}

	</update>

	<select id="countNoticeuser" resultType="java.lang.Integer">
		select count(n.id) from t_member_noticeuser n
		inner join t_wx_bus_member w on n.busId=w.id
		where noticeId=#{noticeId}
		<if test="status>0">
			and status=#{status}
		</if>
	</select>


	<select id="findNoticeuser" resultType="Map">
		select n.*,w.nickName from t_member_noticeuser n
		inner join t_wx_bus_member w on n.busId=w.id
		where n.noticeId=#{noticeId}
		<if test="status>0">
			 and status=#{status}
		</if>
		LIMIT #{fristpage},#{pagesize}

	</select>


	<select id="findReSendNoticeUser" resultType="Map">
		select * from t_member_noticeuser where noticeId=#{noticeId}  and status=5

	</select>

</mapper>
