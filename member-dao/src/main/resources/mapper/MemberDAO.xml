<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.member.dao.MemberDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.gt.member.entity.Member">
		<id column="id" property="id" />
		<result column="df_member_id" property="dfMemberId" />
		<result column="public_id" property="publicId" />
		<result column="fans_currency" property="fansCurrency" />
		<result column="flow" property="flow" />
		<result column="integral" property="integral" />
		<result column="level" property="level" />
		<result column="openid" property="openid" />
		<result column="phone" property="phone" />
		<result column="nickname" property="nickname" />
		<result column="nickname" property="nickname"
				typeHandler="com.gt.member.entity.ConvertBlobTypeHandler" />
		<result column="sex" property="sex" />
		<result column="province" property="province" />
		<result column="city" property="city" />
		<result column="country" property="country" />
		<result column="headimgurl" property="headimgurl" />
		<result column="operate_type" property="operateType" />
		<result column="mc_id" property="mcId" />
		<result column="totalMoney" property="totalMoney" />
		<result column="totalIntegral" property="totalIntegral" />
		<result column="address" property="address" />
		<result column="email" property="email" />
		<result column="cardId" property="cardId" />
		<result column="cardImgback" property="cardImgback" />
		<result column="cardImg" property="cardImg" />
		<result column="birth" property="birth" />
		<result column="currencyDate" property="currencyDate" />
		<result column="flowDate" property="flowDate" />
		<result column="integralDate" property="integralDate" />
		<result column="shareCount" property="shareCount" />
		<result column="shareDate" property="shareDate" />
		<result column="remark" property="remark" />
		<result column="cardChecked" property="cardChecked" />
		<result column="name" property="name" />
		<result column="isBuy" property="isBuy" />
		<result column="isSubscribe" property="isSubscribe" />
		<result column="scence_code" property="scenceCode" />
		<result column="busId" property="busId" />
		<result column="pwd" property="pwd" />
		<result column="loginMode" property="loginMode" />
		<result column="oldId" property="oldId" />
		<result column="subscribeDate" property="subscribeDate" />
		<result column="openid2" property="openid2" />
	</resultMap>

	<!-- 通用查询结果列 -->
	<sql id="Base_Column_List">
        id, df_member_id , public_id , fans_currency, flow, integral, level, openid, phone, nickname, sex, province, city,
        country, headimgurl, operate_type , mc_id , totalMoney, totalIntegral, address, email, cardId, cardImgback,
        cardImg, birth, currencyDate, flowDate, integralDate, shareCount, shareDate, remark, cardChecked, name, isBuy,
        isSubscribe, scence_code , busId, pwd, loginMode, oldId, subscribeDate, openid2
    </sql>


	<select id="selectById" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member
		where id=#{id}
	</select>




	<select id="totalCountMember" resultType="java.lang.Integer">
		select count(*)
		from
		t_wx_bus_member
		where busId = #{busId}
	</select>
	<!-- <resultMap id="BaseResultMap" type="com.gt.member.entity.Member" extends="BaseResultMap"
		> WARNING - @mbggenerated This element is automatically generated by MyBatis
		Generator, do not modify. This element was generated on Fri Jan 22 17:08:45
		CST 2016. <result column="nickname" property="nickname" jdbcType="LONGVARBINARY"
		/> </resultMap> -->

	<select id="selectByOpenid" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member
		where openid =#{openid,jdbcType=VARCHAR}
		and  busId=(SELECT `bus_user_id` FROM `t_wx_public_users` WHERE id= #{public_id,jdbcType=INTEGER})
	</select>
	<select id="selectByPublicIdAndPhone" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member
		where public_id = #{public_id} AND phone=#{phone}
	</select>


	<select id="findMemberBybusId" resultType="Map">
		SELECT mc.mc_id,mc.money,
		mc.isChecked, mc.changeCardType, mc.cardNo,
		mc.receivedate, mc.isbinding,
		ct.ct_name,
		mc.source,mc.cardStatus,mc.frequency,mc.expireDate,mc.ct_id,
		gt.gt_grade_name
		FROM
		(SELECT c.cardStatus, c.money, c.isChecked,
		c.changeCardType, c.cardNo,
		c.receivedate, c.mc_id, c.ct_id, c.gt_id,
		c.isbinding,c.source,c.frequency,c.expireDate FROM t_member_card c
		WHERE c.busId=#{busId}
		<if test="ctId!=0">
			and c.ct_id=#{ctId}
		</if>
		<if test="gtId!=0">
			and c.gt_id=#{gtId}
		</if>
		<if test="source!=null">
			and c.source=1
		</if>
		<if test="changeCardType!=null">
			and c.changeCardType=1
		</if>
		<if test="search!=null">
			and c.cardNo = #{search}
		</if>
		<if test="startDate!=null">
			and c.receivedate <![CDATA[>=]]>
			#{startDate}
		</if>
		<if test="endDate!=null">
			and c.receivedate <![CDATA[<=]]>
			#{endDate}
		</if>

		order by c.mc_id desc
		) mc
		INNER JOIN t_member_cardtype AS ct ON
		ct.ct_id = mc.ct_id
		INNER JOIN t_member_gradetype AS gt ON gt.gt_id =
		mc.gt_id
		LIMIT #{fristpage},#{pagesize}
	</select>


	<select id="countMember" resultType="java.lang.Integer">
		SELECT
		COUNT(mc.mc_id)
		FROM
		(SELECT c.mc_id,cardNo FROM t_member_card c
		WHERE c.busId=#{busId}
		<if test="ctId!=0">
			and c.ct_id=#{ctId}
		</if>
		<if test="gtId!=0">
			and c.gt_id=#{gtId}
		</if>
		<if test="source!=null">
			and c.source=1
		</if>
		<if test="changeCardType!=null">
			and c.changeCardType=1
		</if>
		<if test="startDate!=null">
			and c.receivedate <![CDATA[>=]]>
			#{startDate}
		</if>
		<if test="endDate!=null">
			and c.receivedate <![CDATA[<=]]>
			#{endDate}
		</if>
		) mc
		INNER JOIN (SELECT mc_id,phone FROM t_wx_bus_member
		bm WHERE
		bm.busId=#{busId} and bm.mc_id is not null) m ON m.mc_id = mc.mc_id
		where 1=1
		<if test="search!=null">
			and mc.cardNo=#{search}
		</if>
		<if test="phone!=null">
			and m.phone=#{phone}
		</if>

	</select>


	<select id="findMember" resultType="Map">
		SELECT
		m.fans_currency, m.flow, m.integral, m.phone, m.nickname, m.sex,
		m.totalMoney,
		mc.money,
		mc.cardNo, mc.receivedate,
		ct.ct_name,gt.gt_grade_name,mc.ct_id,mc.expireDate,mc.frequency
		FROM
		(SELECT c.money, c.mc_id, c.cardNo, c.receivedate, c.ct_id,
		c.gt_id,c.expireDate,c.frequency FROM t_member_card c WHERE
		c.busId=#{busId}
		<if test="ctId!=-1">
			and c.ct_id=#{ctId}
		</if>
		<if test="gtId!=0">
			and c.gt_id=#{gtId}
		</if>
		<if test="ctId==-1">
			and c.source=1
		</if>
		) mc
		INNER JOIN (SELECT id, fans_currency, flow, integral, phone,
		nickname, sex,
		totalMoney,
		mc_id FROM t_wx_bus_member bm WHERE
		bm.busId=#{busId}) m ON m.mc_id =
		mc.mc_id
		INNER JOIN t_member_cardtype
		AS ct ON ct.ct_id = mc.ct_id
		INNER JOIN t_member_gradetype AS gt ON
		gt.gt_id = mc.gt_id
		where 1=1
		<if test="search!=null and search!=''">
			and (mc.cardNo=#{search} or m.phone=#{search})
		</if>

	</select>

	<select id="findByMcId" resultMap="BaseResultMap">
		select * from t_wx_bus_member
		where busId=#{busId} and phone=#{phone}
		and mc_id=#{mcId} limit
		1
	</select>


	<select id="findByMcIdAndbusId" resultMap="BaseResultMap">
		select * from
		t_wx_bus_member where busId=#{busId} and mc_id=#{mcId}
		limit 1
	</select>

	<select id="findByMemberIds" resultType="Map">
		select id,phone,nickname,mc_id,fans_currency,flow,integral from t_wx_bus_member where busId=#{busId} and id in
		<foreach close=")" collection="memberIds" item="id" open="("
				 separator=",">
			#{id}
		</foreach>

	</select>

	<select id="findBybusIdAndNotMcId" resultType="Map">
		select * from
		t_wx_bus_member where busId=#{busId} and mc_id is not
		null
	</select>

	<select id="findBybusIdAndctId" resultType="Map">
		SELECT * FROM t_wx_bus_member WHERE busId=#{busId} and mc_id IN
		(SELECT mc_id FROM t_member_card WHERE ct_id IN
		<foreach close=")" collection="ctIds" item="ctId" open="("
				 separator=",">
			#{ctId}
		</foreach>
		)
	</select>


	<select id="findBymcIds" resultType="Map">
		select id from t_wx_bus_member where busId=#{busId} and mc_id
		in
		<foreach close=")" collection="mcIds" item="mcId" open="("
				 separator=",">
			#{mcId}
		</foreach>
	</select>

	<select id="findByNameAndtelPhone" resultType="java.lang.Integer">
		select id from
		t_wx_bus_member where public_id=#{publicId} and name=#{name}
		and
		phone=#{phone} and mc_id IS NOT NULL
	</select>

	<!-- cz -->
	<select id="findCardPhoneMember" resultType="Map">
		select
		tc.cardNo,
		tc.ct_id,
		tc.money,
		tm.nickname,
		tm.headimgurl,
		tm.sex,
		tm.phone,
		tc.receivedate,
		ct.ct_name,
		gt.gt_grade_name,
		tm.flow,
		tm.integral,
		gr.gr_discount
		from t_wx_bus_member tm
		RIGHT JOIN t_member_card tc ON tm.mc_id=tc.mc_id
		INNER JOIN t_member_cardtype ct ON ct.ct_id=tc.ct_id
		INNER JOIN t_member_gradetype gt ON gt.gt_id=tc.gt_id
		inner join t_member_giverule gr on gr.gr_id=tc.gr_id
		where (tm.phone=#{search} or tc.cardNo=#{search}) and tc.busId=#{busid}
	</select>

	<!-- cz -->
	<select id="findTodayAddFans" resultType="Map">
		select
		tm.id,
		tm.nickname,
		tm.headimgurl
		from t_wx_bus_member tm
		where
		DATE_FORMAT(tm.subscribeDate,'%Y-%m-%d')=DATE_FORMAT(SYSDATE(),'%Y-%m-%d')
		and tm.busId=#{busid}
		and tm.mc_id is null
		order by tm.subscribeDate desc
	</select>

	<select id="findById" resultType="Map">
		SELECT id, df_member_id,
		fans_currency, flow, integral, LEVEL,
		openid,birth,subscribeDate,email,
		phone,m.busId,
		nickname, sex,
		province, city,
		country, headimgurl, operate_type, totalMoney,
		totalIntegral,mc.money,m.mc_id,name,
		mc.cardNo,mc.receivedate,ct.ct_name,gt.gt_grade_name,remark FROM
		t_wx_bus_member m
		RIGHT JOIN t_member_card mc ON m.mc_id=mc.mc_id
		INNER
		JOIN t_member_cardtype AS ct ON ct.ct_id=mc.ct_id
		INNER JOIN
		t_member_gradetype AS gt ON gt.gt_id=mc.gt_id
		where m.id=#{memberId}
	</select>

	<select id="findCardNo" resultType="Map">
		SELECT
		id,
		df_member_id,
		fans_currency,
		flow,
		integral,
		LEVEL,
		openid,
		birth,
		subscribeDate,
		email,
		phone,
		nickname,
		sex,
		province,
		city,
		country,
		headimgurl,
		m.busId,
		operate_type,
		totalMoney,
		totalIntegral,
		mc.money,
		m.mc_id,
		name,
		mc.cardNo,
		mc.receivedate,
		ct.ct_name,
		gt.gt_grade_name,
		remark
		FROM
		t_wx_bus_member m
		RIGHT JOIN t_member_card mc ON m.mc_id=mc.mc_id
		INNER
		JOIN t_member_cardtype AS ct ON ct.ct_id=mc.ct_id
		INNER JOIN
		t_member_gradetype AS gt ON gt.gt_id=mc.gt_id
		where mc.cardNo=#{cardNo}
	</select>





	<!-- 查询粉丝总数 -->
	<select id="queryFansNum" parameterType="java.lang.Integer"
			resultType="java.lang.Integer">
		SELECT COUNT(*) FROM t_wx_bus_member WHERE
		public_id=#{wxUserId}
	</select>

	<!-- 查询随机的中奖人 -->
	<select id="randNumUser" parameterType="java.lang.Integer"
			resultMap="BaseResultMap">
		SELECT openid,headimgurl,nickname FROM t_wx_bus_member
		WHERE
		id &gt;=
		(SELECT floor(RAND() * (SELECT MAX(id) FROM t_wx_bus_member)))
		and
		public_id = #{wxUserId} and openid is not null AND headimgurl is
		not
		null
		ORDER BY id LIMIT 100

	</select>

	<!-- 查询用户信息 -->
	<select id="selectOpenid" resultMap="BaseResultMap">
		select * from
		t_wx_bus_member
		where public_id=#{wxUserId} and openid=#{ids}
	</select>


	<!-- 根据openid去查询用户信息 -->
	<select id="queryOpenid"
			resultMap="BaseResultMap">
		select  <include refid="Base_Column_List" /> from t_wx_bus_member where openid = #{string}
	</select>

	<!-- 查询大屏摇一摇用户 -->

	<select id="queryShakeFans" resultMap="BaseResultMap">
		select
		id,openid,nickname,headimgurl from t_wx_bus_member where public_id =
		#{wxUserId}
	</select>


	<!-- 查询用户信息 -->
	<select id="queryMax" parameterType="java.lang.String"
			resultMap="BaseResultMap">
		select openid,nickname,headimgurl from t_wx_bus_member where
		openid = #{openid}
	</select>

	<!-- 查询签到的用户信息 -->
	<select id="queryWxUserId" resultMap="BaseResultMap">
		select
		id,openid,sex,nickname,sex,headimgurl
		from
		t_wx_bus_member t
		where
		t.public_id = #{userId}
	</select>

	<!-- 根据openid查询所属公众号ID -->
	<select id="selectByPublicId" parameterType="java.lang.String"
			resultType="java.lang.Integer">
		select
		public_id
		from t_wx_bus_member
		where
		openid = #{openid}
	</select>

	<!-- 查询签到的用户信息 -->
	<select id="selectByKey" resultMap="BaseResultMap" resultType="java.lang.Integer">
		select
		id,public_id,openid,sex,nickname,sex,headimgurl
		from
		t_wx_bus_member t
		where
		t.id = #{id}
	</select>

	<select id="selectIdByOpenid" parameterType="java.lang.String" resultType="Map">
		select
		id
		from t_wx_bus_member
		where
		openid = #{openid}
	</select>

	<select id="countCommend" resultType="java.lang.Integer">
		select count(t.id) from t_member_recommend t inner join
		t_wx_bus_member m on m.id=t.memberId
		where m.busId=#{busId}
		<if test="recommendType!=null">
			and t.recommendType=#{recommendType}
		</if>
		<if test="search!=null">
			and (t.name=#{search} or t.phone=#{search})
		</if>
	</select>

	<select id="findCommend" resultType="Map">
		select t.id, t.name, t.phone AS tphone, t.ischeck, t.ctId, t.image,
		t.isUser,t.datetime,t.cardName,t.recommendType,
		m.nickname,
		m.phone as mphone,t.integral,t.fenbi,t.flow,t.money  from
		t_member_recommend t inner join t_wx_bus_member m on m.id=t.memberId
		where m.busId=#{busId}
		<if test="recommendType!=null">
			and t.recommendType=#{recommendType}
		</if>

		<if test="search!=null">
			and (t.name=#{search} or t.phone=#{search})
		</if>
		order by t.id desc
		limit #{fristpage},#{pagesize}
	</select>

	<!-- 根据活动Id去修改用户的粉币or流量or积分 -->
	<update id="updateAddKey" parameterType="com.gt.member.entity.Member">
		update t_wx_bus_member
		<set>
			<if test="fansCurrency != null"><!-- 粉币 -->
				fans_currency =fans_currency+ #{fansCurrency,jdbcType=DOUBLE},
			</if>
			<if test="flow != null"><!-- 流量 -->
				flow = flow+ #{flow,jdbcType=INTEGER},
			</if>
			<if test="integral != null"><!-- 积分 -->
				integral =integral+ #{integral,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>

	<select id="selectBybusIdAndPhone" resultMap="BaseResultMap">
		select * from
		t_wx_bus_member where busId=#{busId} and phone =#{phone}
	</select>


	<select id="selectByPhoneAndPwd" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member where busId=#{busId}
		and phone =#{phone} and
		pwd=#{pwd}
	</select>

	<select id="findByPhone" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member where busId=#{busId} and phone =#{phone}
	</select>


	<select id="findMemberBymcIds" resultType="Map">
		select m.id, m.fans_currency, m.flow, m.integral, m.phone, m.nickname,
		m.sex, m.totalMoney, m.cardChecked, m.remark,m.mc_id from
		t_wx_bus_member m
		where m.busId=#{busId} and m.mc_id is not null
		<if test="phone!=null">
			and phone=#{phone}
		</if>
		and
		<foreach close=")" collection="mcIds" item="mcId" open="("
				 separator="or">
			m.mc_id=#{mcId}
		</foreach>
	</select>

	<select id="findNewMemberByBusId" resultType="Map">
		select
		id,nickname,phone,headimgurl,subscribeDate from t_wx_bus_member where
		busId=#{busId} and loginMode=0 and openId is not null and mc_id is null and subscribeDate
		&gt;= #{date} order by subscribeDate desc limit 3
	</select>


	<select id="getByOpenid2" resultMap="BaseResultMap"
			parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member
		where openid2 = #{openid2} limit 0,1
	</select>


	<select id="findByMcId1" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member where mc_id=#{mcId}
	</select>


	<select id="findMemberBybusIdAndPhone" resultType="Map">
		SELECT mc.mc_id,mc.money,
		mc.isChecked,   mc.changeCardType,  mc.cardNo,  mc.receivedate, mc.isbinding,  ct.ct_name,
		mc.source,mc.cardStatus,mc.frequency,mc.expireDate,mc.ct_id,
		gt.gt_grade_name
		FROM
		(SELECT c.cardStatus,  c.money,   c.isChecked,   c.changeCardType,  c.cardNo,  c.receivedate,  c.mc_id,  c.ct_id,  c.gt_id,  c.isbinding,c.source,c.frequency,c.expireDate  FROM t_member_card c
		WHERE c.busId=#{busId} and mc_id=#{mcId}
		order by c.mc_id desc
		) mc
		INNER JOIN t_member_cardtype AS ct ON ct.ct_id = mc.ct_id
		INNER JOIN t_member_gradetype AS gt  ON gt.gt_id = mc.gt_id
	</select>


	<select id="findMemberByPhone" resultType="Map">
		select m.id,  m.fans_currency,   m.flow,  m.integral,    m.phone,  m.nickname,    m.sex,  m.totalMoney,    m.cardChecked, m.remark,m.mc_id from t_wx_bus_member m
		where m.busId=#{busId}
		and phone=#{phone}
	</select>


	<update id="updateJifen">
		update t_wx_bus_member set integral=integral-#{jifen} where busId=#{busId} and mc_id=#{mcId}
	</update>


	<select id="findLoginMode2ByPhone" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_wx_bus_member where busId=#{busId} and phone =#{phone}
	</select>

	<select id="countJifen" resultType="java.lang.Integer">
		select sum(m.integral) from t_wx_bus_member m inner join t_member_card c on m.mc_id=c.mc_id  where m.busId=#{busId} and c.ct_id=1
	</select>

	<select id="findSexGroupBySex" resultType="Map">
		SELECT COUNT(m.id) as countId,m.sex FROM t_wx_bus_member m inner join t_member_card c on m.mc_id=c.mc_id  WHERE  m.busId=#{busId} and c.ct_id=#{ctId} and m.mc_id IS NOT NULL GROUP BY m.sex
	</select>

	<select id="selectByPrimaryKeys" resultMap="BaseResultMap">
		SELECT <include refid="Base_Column_List" /> FROM t_wx_bus_member where id in (${ids})
	</select>


	<update id="updateMemberByMcId">
		update t_wx_bus_member set mc_id=null where busId=#{busId} and mc_id=#{mcId}
	</update>

	<select id="countMemberIsNotCard" resultType="java.lang.Integer">
		select count(*) from t_wx_bus_member where busId=#{busId} and loginMode=0 and mc_id is null
	</select>

	<select id="findMemberIsNotCard" resultType="Map">
		select id ,nickname,headimgurl,subscribeDate from t_wx_bus_member
		where busId=#{busId} and loginMode=0 and mc_id is null  ORDER BY subscribeDate DESC LIMIT #{fristpage},#{pagesize}

	</select>

	<select id="selectByOpenidAndBusId" resultMap="BaseResultMap">
		SELECT <include refid="Base_Column_List" /> FROM t_wx_bus_member where  busId=#{busId} and openid=#{openid}
	</select>


	<select id="findMemberByIds" resultType="Map">
		select id,nickname,phone,headimgurl from t_wx_bus_member where  busId=#{busId} and
		<foreach close=")" collection="ids" item="id" open="(" separator="or">
			id=#{id}
		</foreach>
	</select>

	<select id="findMemberByPhoneAndBusId" resultType="Map">
		select id,nickname,phone,headimgurl from t_wx_bus_member where  busId=#{busId} and phone=#{phone}

	</select>

</mapper>
